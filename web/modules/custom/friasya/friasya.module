<?php

use Drupal\node\Entity\Node;

/**
 * Implementa hook_entity_insert().
 */
function friasya_entity_insert(\Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->getEntityTypeId() === 'node' && $entity->bundle() === 'transaccion') {
    \Drupal::logger('friasya')->notice('hook_entity_insert ejecutado para transacción.');

    // Validar campo field_productos (referencia al producto).
    if (!$entity->hasField('field_productos') || $entity->get('field_productos')->isEmpty()) {
      \Drupal::logger('friasya')->warning('Transacción sin producto asociado.');
      return;
    }

    // Obtener el nodo producto.
    $producto_nid = $entity->get('field_productos')->target_id;
    $producto = Node::load($producto_nid);
    if (!$producto || $producto->bundle() !== 'producto') {
      \Drupal::logger('friasya')->warning('Producto inválido o no encontrado: @nid', ['@nid' => $producto_nid]);
      return;
    }

    // Obtener cantidad.
    $cantidad = 1;
    if ($entity->hasField('field_cantidad') && !$entity->get('field_cantidad')->isEmpty()) {
      $cantidad_valor = (int) $entity->get('field_cantidad')->value;
      if ($cantidad_valor > 0) {
        $cantidad = $cantidad_valor;
      }
    }

    \Drupal::logger('friasya')->notice('Producto NID: @nid - Cantidad: @cantidad', [
      '@nid' => $producto_nid,
      '@cantidad' => $cantidad,
    ]);

    // Verificar y actualizar el stock.
    if ($producto->hasField('field_stock') && !$producto->get('field_stock')->isEmpty()) {
      $stock_actual = (int) $producto->get('field_stock')->value;

      \Drupal::logger('friasya')->notice('Stock actual del producto @nid: @stock', [
        '@nid' => $producto_nid,
        '@stock' => $stock_actual,
      ]);

      $nuevo_stock = max(0, $stock_actual - $cantidad);
      $producto->set('field_stock', $nuevo_stock);
      $producto->save();

      \Drupal::logger('friasya')->notice('Stock actualizado a @nuevo para producto @nid', [
        '@nuevo' => $nuevo_stock,
        '@nid' => $producto_nid,
      ]);
    }
    else {
      \Drupal::logger('friasya')->warning('El producto @nid no tiene field_stock configurado o está vacío.', ['@nid' => $producto_nid]);
    }
  }
}
